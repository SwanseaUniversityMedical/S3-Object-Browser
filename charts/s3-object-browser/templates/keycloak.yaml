{{- if .Values.keycloak.enabled }}
apiVersion: v1
kind: Service
metadata:
  name: keycloak
  namespace: {{ .Release.Namespace }}
  labels:
    app: keycloak
spec:
  ports:
    - port: {{ .Values.keycloak.service.port }}
      targetPort: 8080
      protocol: TCP
  selector:
    app: keycloak
  type: {{ .Values.keycloak.service.type }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-realm-import
  namespace: {{ .Release.Namespace }}
data:
  realm-export.json: |
    {
      "id": "object-browser",
      "realm": "object-browser",
      "displayName": "Object Browser",
      "enabled": true,
      "sslRequired": "none",
      "registrationAllowed": true,
      "rememberMe": true,
      "verifyEmail": false,
      "loginWithEmailAllowed": true,
      "resetPasswordAllowed": true,
      "bruteForceProtected": true,
      "users": [
        {
          "username": "testuser",
          "enabled": true,
          "email": "testuser@example.com",
          "firstName": "Test",
          "lastName": "User",
          "credentials": [
            {
              "type": "password",
              "value": "password",
              "temporary": false
            }
          ]
        },
        {
          "username": "admin",
          "enabled": true,
          "email": "admin@example.com",
          "firstName": "Admin",
          "lastName": "User",
          "credentials": [
            {
              "type": "password",
              "value": "admin",
              "temporary": false
            }
          ]
        }
      ],
      "clients": [
        {
          "clientId": "object-browser-client",
          "name": "Object Browser Client",
          "enabled": true,
          "clientAuthenticatorType": "client-secret",
          "secret": "object-browser-client-secret",
          "redirectUris": [
            "http://localhost:9090/*"
          ],
          "webOrigins": [
            "http://localhost:9090"
          ],
          "protocol": "openid-connect",
          "publicClient": false,
          "standardFlowEnabled": true,
          "directAccessGrantsEnabled": true,
          "fullScopeAllowed": true,
          "attributes": {
            "access.token.lifespan": "3600"
          },
          "protocolMappers": [
            {
              "name": "email",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "config": {
                "userinfo.token.claim": "true",
                "user.attribute": "email",
                "id.token.claim": "true",
                "access.token.claim": "true",
                "claim.name": "email",
                "jsonType.label": "String"
              }
            },
            {
              "name": "preferred_username",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "config": {
                "userinfo.token.claim": "true",
                "user.attribute": "username",
                "id.token.claim": "true",
                "access.token.claim": "true",
                "claim.name": "preferred_username",
                "jsonType.label": "String"
              }
            },
            {
              "name": "policy",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-hardcoded-claim-mapper",
              "config": {
                "claim.value": "readwrite",
                "userinfo.token.claim": "true",
                "id.token.claim": "true",
                "access.token.claim": "true",
                "claim.name": "policy",
                "jsonType.label": "String"
              }
            }
          ]
        }
      ]
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
  namespace: {{ .Release.Namespace }}
  labels:
    app: keycloak
spec:
  replicas: {{ .Values.keycloak.replicas }}
  selector:
    matchLabels:
      app: keycloak
  template:
    metadata:
      labels:
        app: keycloak
    spec:
      containers:
      - name: keycloak
        image: "{{ .Values.keycloak.image.repository }}:{{ .Values.keycloak.image.tag }}"
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: http
        command:
          - /opt/keycloak/bin/kc.sh
          - start-dev
          - --db=postgres
          - --db-url=jdbc:postgresql://postgres:5432/keycloak
          - --db-username={{ .Values.postgres.auth.username }}
          - --db-password={{ .Values.postgres.auth.password }}
          {{- if .Values.keycloak.realmImport }}
          - --import-realm
          {{- end }}
        env:
        - name: KC_DB
          value: {{ .Values.keycloak.environment.KC_DB }}
        - name: KC_DB_URL
          value: "jdbc:postgresql://postgres:5432/keycloak"
        - name: KC_DB_USERNAME
          value: {{ .Values.postgres.auth.username }}
        - name: KC_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: password
        - name: KC_DB_URL_HOST
          value: postgres
        - name: KC_DB_URL_PORT
          value: "5432"
        - name: KC_DB_URL_DATABASE
          value: {{ .Values.postgres.auth.database }}
        - name: KC_HOSTNAME
          value: {{ .Values.keycloak.environment.KC_HOSTNAME }}
        - name: KC_HOSTNAME_PORT
          value: {{ .Values.keycloak.environment.KC_HOSTNAME_PORT | quote }}
        - name: KC_HOSTNAME_STRICT
          value: {{ .Values.keycloak.environment.KC_HOSTNAME_STRICT | quote }}
        - name: KC_HOSTNAME_STRICT_HTTPS
          value: {{ .Values.keycloak.environment.KC_HOSTNAME_STRICT_HTTPS | quote }}
        - name: KC_HTTP_ENABLED
          value: {{ .Values.keycloak.environment.KC_HTTP_ENABLED | quote }}
        - name: KC_HEALTH_ENABLED
          value: {{ .Values.keycloak.environment.KC_HEALTH_ENABLED | quote }}
        - name: KC_LOG_LEVEL
          value: {{ .Values.keycloak.environment.KC_LOG_LEVEL }}
        - name: KC_TRANSACTION_XA_ENABLED
          value: {{ .Values.keycloak.environment.KC_TRANSACTION_XA_ENABLED | quote }}
        - name: KEYCLOAK_ADMIN
          value: {{ .Values.keycloak.environment.KEYCLOAK_ADMIN }}
        - name: KEYCLOAK_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: keycloak-secret
              key: admin-password
        resources:
          requests:
            memory: {{ .Values.keycloak.resources.requests.memory }}
            cpu: {{ .Values.keycloak.resources.requests.cpu }}
          limits:
            memory: {{ .Values.keycloak.resources.limits.memory }}
            cpu: {{ .Values.keycloak.resources.limits.cpu }}
        volumeMounts:
        - name: realm-import
          mountPath: /opt/keycloak/data/import
        {{- if .Values.keycloak.healthcheck.enabled }}
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: {{ .Values.keycloak.healthcheck.initialDelaySeconds }}
          periodSeconds: {{ .Values.keycloak.healthcheck.periodSeconds }}
          timeoutSeconds: {{ .Values.keycloak.healthcheck.timeoutSeconds }}
          failureThreshold: {{ .Values.keycloak.healthcheck.failureThreshold }}
        {{- end }}
      volumes:
      - name: realm-import
        configMap:
          name: keycloak-realm-import
---
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-secret
  namespace: {{ .Release.Namespace }}
type: Opaque
stringData:
  admin-password: {{ .Values.keycloak.environment.KEYCLOAK_ADMIN_PASSWORD | quote }}
{{- end }}
